services:
  # ------------------------------------
  # Frontend: React (Vite)
  # ------------------------------------
  client:
    build: ./client
    container_name: apm-client # ชื่อนี้ต้องตรงกับ proxy_pass ใน nginx ตัวแม่
    restart: always
    ports:
      - "3001:80"
    networks:
      - shared-network

  # ------------------------------------
  # Backend: Node.js Express
  # ------------------------------------
  server:
    build: ./server
    container_name: apm-server # ชื่อนี้ต้องตรงกับ proxy_pass ใน nginx ตัวแม่
    restart: always
    ports:
      - "3002:3002"
    # ตั้งค่า Environment Variable (Overrides ไฟล์ .env)
    environment:
      - PORT=3002
      # **สำคัญมาก**: การเชื่อมต่อ DB ใน Docker Network เดียวกัน
      # ให้ใช้ชื่อ Service "db-mysql" และ Port ภายใน "3306" (ไม่ใช่ 12306)
      - DB_HOST=db-mysql
      - DB_PORT=3306
      # ค่าอื่นๆ อ่านจากไฟล์ .env
    env_file:
      - ./server/.env
    networks:
      - shared-network

# เชื่อมต่อกับ Network ภายนอกที่ Nginx/MySQL ใช้งานอยู่
networks:
  shared-network:
    external: true
